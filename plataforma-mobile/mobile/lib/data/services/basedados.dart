import 'dart:async';
import 'package:sqflite/sqflite.dart';
import 'package:path/path.dart';

class Basedados {
  static const bdsoftskills = "bdsoftskills.db";
  final int versao = 1;
  static Database? _basededados;
  final bool estado = false;

  Future<Database> get basededados async {
    if(_basededados != null)
      return _basededados!;
    
    _basededados = await _initDatabase();
    return _basededados!;
  } 
  _initDatabase() async {
    String path = join(await getDatabasesPath(), bdsoftskills);
    return await openDatabase(path,
      version: versao, onCreate: _onCreate);
  }
  Future _onCreate (Database db, int version) async {
    
  }
  
  Future<void> criartabelas() async {
  Database db = await basededados;

  await db.execute('''
    CREATE TABLE CATEGORIA IF NOT EXISTS (
      ID_CATEGORIA INTEGER PRIMARY KEY AUTOINCREMENT,
      NOME_CAT TEXT NOT NULL,
      DESCRICAO_CAT TEXT
    )
  ''');

  await db.execute('''
    CREATE TABLE AREA IF NOT EXISTS (
      ID_AREA INTEGER PRIMARY KEY AUTOINCREMENT,
      ID_CATEGORIA INTEGER NOT NULL,
      NOME_AREA TEXT NOT NULL,
      DESCRICAO_AR TEXT,
      FOREIGN KEY (ID_CATEGORIA) REFERENCES CATEGORIA(ID_CATEGORIA)
    )
  ''');

  await db.execute('''
    CREATE TABLE TOPICO IF NOT EXISTS (
      ID_TOPICO INTEGER PRIMARY KEY AUTOINCREMENT,
      ID_AREA INTEGER NOT NULL,
      NOME_TOPICO TEXT NOT NULL,
      DESCRICAO_TOP TEXT,
      FOREIGN KEY (ID_AREA) REFERENCES AREA(ID_AREA)
    )
  ''');

  await db.execute('''
    CREATE TABLE UTILIZADOR (
      ID_UTILIZADOR INTEGER PRIMARY KEY AUTOINCREMENT,
      NOME_UTILIZADOR TEXT NOT NULL,
      PASSWORD_UTIL TEXT NOT NULL,
      DATA_CRIACAO_UTILIZ TEXT NOT NULL,
      TELEMOVEL INTEGER,
      GENERO INTEGER NOT NULL,
      MORADA TEXT NOT NULL,
      PAIS TEXT NOT NULL,
      DATA_NASC TEXT NOT NULL,
      EMAIL TEXT NOT NULL,
      DATA_ATIV_UTILI TEXT,
      AUTEN2FAT INTEGER
    )
  ''');

  await db.execute('''
    CREATE TABLE S_S_O (
      ID_SSO INTEGER PRIMARY KEY AUTOINCREMENT,
      ID_UTILIZADOR INTEGER NOT NULL,
      EMAIL_SSO TEXT NOT NULL,
      TOKEN TEXT NOT NULL,
      FOREIGN KEY (ID_UTILIZADOR) REFERENCES UTILIZADOR(ID_UTILIZADOR)
    )
  ''');

  await db.execute('''
    CREATE TABLE "2FA" (
      ID_2FA INTEGER PRIMARY KEY AUTOINCREMENT,
      ID_UTILIZADOR INTEGER NOT NULL,
      CODIGO TEXT NOT NULL,
      DATA_FA TEXT NOT NULL,
      FOREIGN KEY (ID_UTILIZADOR) REFERENCES UTILIZADOR(ID_UTILIZADOR)
    )
  ''');

  await db.execute('''
      CREATE TABLE GESTOR_ADMINISTRADOR (
        ID_UTILIZADOR INTEGER NOT NULL,
        ID_GESTOR_ADMINISTRADOR INTEGER PRIMARY KEY AUTOINCREMENT,
        NOME_UTILIZADOR TEXT NOT NULL,
        PASSWORD_UTIL TEXT NOT NULL,
        DATA_CRIACAO_UTILIZ TEXT NOT NULL,
        TELEMOVEL INTEGER,
        GENERO INTEGER NOT NULL,
        MORADA TEXT NOT NULL,
        PAIS TEXT NOT NULL,
        DATA_NASC TEXT NOT NULL,
        EMAIL TEXT NOT NULL,
        DATA_ATIV_UTILI TEXT,
        AUTEN2FAT INTEGER,
        FOREIGN KEY (ID_UTILIZADOR) REFERENCES UTILIZADOR(ID_UTILIZADOR)
      )
  ''');

  await db.execute('''
    CREATE TABLE FORMADORES (
      ID_UTILIZADOR INTEGER NOT NULL,
      ID_FORMADOR INTEGER PRIMARY KEY AUTOINCREMENT,
      ESPECIALIDADES TEXT,
      EXPERIENCIA TEXT,
      FOREIGN KEY (ID_UTILIZADOR) REFERENCES UTILIZADOR(ID_UTILIZADOR)
    )
  ''');

  await db.execute('''
    CREATE TABLE FORMANDOS (
      ID_UTILIZADOR INTEGER NOT NULL,
      ID_FORMANDO INTEGER PRIMARY KEY AUTOINCREMENT,
      PERCURSO_FORMATIVO TEXT,
      FOREIGN KEY (ID_UTILIZADOR) REFERENCES UTILIZADOR(ID_UTILIZADOR)
    )
  ''');

  await db.execute('''
    CREATE TABLE CURSOS (
      ID_CURSO INTEGER PRIMARY KEY AUTOINCREMENT,
      ID_TOPICO INTEGER NOT NULL,
      ID_UTILIZADOR INTEGER NOT NULL,
      ID_GESTOR_ADMINISTRADOR INTEGER NOT NULL,
      ID_CATEGORIA INTEGER NOT NULL,
      ID_AREA INTEGER NOT NULL,
      NOME_CURSO TEXT NOT NULL,
      DESCRICAO_CURSO TEXT NOT NULL,
      NUMERO_VAGAS INTEGER,
      DATA_INICIO_CURSO TEXT NOT NULL,
      DATA_FIM_CURSO TEXT NOT NULL,
      TIPO_CURSO INTEGER NOT NULL,
      ESTADO INTEGER NOT NULL,
      IDIOMA TEXT NOT NULL,
      HORAS_CURSO REAL NOT NULL,
      CONTADOR_FORMANDOS INTEGER NOT NULL,
      IMAGEM TEXT,
      FOREIGN KEY (ID_TOPICO) REFERENCES TOPICO(ID_TOPICO),
      FOREIGN KEY (ID_CATEGORIA) REFERENCES CATEGORIA(ID_CATEGORIA),
      FOREIGN KEY (ID_AREA) REFERENCES AREA(ID_AREA),
      FOREIGN KEY (ID_UTILIZADOR, ID_GESTOR_ADMINISTRADOR) 
        REFERENCES GESTOR_ADMINISTRADOR(ID_UTILIZADOR, ID_GESTOR_ADMINISTRADOR)
    )
  ''');

  await db.execute('''
    CREATE TABLE ASSINCRONO (
      ID_CURSO INTEGER NOT NULL,
      ID_CURSO_ASSINCRONO INTEGER PRIMARY KEY AUTOINCREMENT,
      ID_TOPICO INTEGER NOT NULL,
      ID_GESTOR_ADMINISTRADOR INTEGER NOT NULL,
      ID_CATEGORIA INTEGER NOT NULL,
      ID_AREA INTEGER NOT NULL,
      NOME_CURSO TEXT NOT NULL,
      DESCRICAO_CURSO TEXT NOT NULL,
      NUMERO_VAGAS INTEGER,
      DATA_INICIO_CURSO TEXT NOT NULL,
      DATA_FIM_CURSO TEXT NOT NULL,
      TIPO_CURSO INTEGER NOT NULL,
      ESTADO INTEGER NOT NULL,
      IDIOMA TEXT NOT NULL,
      HORAS_CURSO REAL NOT NULL,
      CONTADOR_FORMANDOS INTEGER NOT NULL,
      IMAGEM TEXT,
      FOREIGN KEY (ID_CURSO) REFERENCES CURSOS(ID_CURSO)
    );
  ''');

  await db.execute('''
    CREATE TABLE AULAS (
      ID_AULA INTEGER PRIMARY KEY AUTOINCREMENT,
      ID_CURSO INTEGER NOT NULL,
      DATA_AULA TEXT NOT NULL,
      NOME_AULA TEXT NOT NULL,
      FOREIGN KEY (ID_CURSO) REFERENCES CURSOS(ID_CURSO)
    )
  ''');

  await db.execute('''
    CREATE TABLE CONTEUDOS_PARTILHADO (
      ID_AREA_CONHECIMENTO INTEGER PRIMARY KEY AUTOINCREMENT,
      ID_AREA INTEGER NOT NULL,
      ID_TOPICO INTEGER NOT NULL,
      ID_CATEGORIA INTEGER NOT NULL,
      DESCRICAO_CP TEXT,
      DATA_CRIACAO_CP TEXT NOT NULL,
      FOREIGN KEY (ID_AREA) REFERENCES AREA(ID_AREA),
      FOREIGN KEY (ID_TOPICO) REFERENCES TOPICO(ID_TOPICO),
      FOREIGN KEY (ID_CATEGORIA) REFERENCES CATEGORIA(ID_CATEGORIA)
    )
  ''');

  await db.execute('''
    CREATE TABLE POST (
      ID_POST INTEGER PRIMARY KEY AUTOINCREMENT,
      ID_UTILIZADOR INTEGER NOT NULL,
      ID_AREA_CONHECIMENTO INTEGER NOT NULL,
      TEXTO_POST TEXT NOT NULL,
      CONTADOR_LIKES_POST INTEGER NOT NULL,
      CONTADOR_COMENTARIOS INTEGER NOT NULL,
      FOREIGN KEY (ID_UTILIZADOR) REFERENCES UTILIZADOR(ID_UTILIZADOR),
      FOREIGN KEY (ID_AREA_CONHECIMENTO) REFERENCES CONTEUDOS_PARTILHADO(ID_AREA_CONHECIMENTO)
    )
  ''');

  await db.execute('''
    CREATE TABLE NOTIFICACOES_POST (
      ID_NOTIFICACAO_POST INTEGER PRIMARY KEY AUTOINCREMENT,
      ID_CURSO INTEGER NOT NULL,
      ID_POST INTEGER NOT NULL,
      ID_UTILIZADOR INTEGER NOT NULL,
      DATA_HORA_NOTIFICACAOCP TEXT NOT NULL,
      FOREIGN KEY (ID_UTILIZADOR) REFERENCES UTILIZADOR(ID_UTILIZADOR),
      FOREIGN KEY (ID_CURSO) REFERENCES CURSOS(ID_CURSO),
      FOREIGN KEY (ID_POST) REFERENCES POST(ID_POST)
    )
  ''');

  await db.execute('''
    CREATE TABLE AVALIACOES (
      ID_AVALIACAO INTEGER PRIMARY KEY AUTOINCREMENT,
      ID_POST INTEGER NOT NULL,
      ID_UTILIZADOR INTEGER NOT NULL,
      AVALIACAO INTEGER NOT NULL,
      FOREIGN KEY (ID_UTILIZADOR) REFERENCES UTILIZADOR(ID_UTILIZADOR),
      FOREIGN KEY (ID_POST) REFERENCES POST(ID_POST)
    )
  ''');

  await db.execute('''
    CREATE TABLE COMENTARIO (
      ID_COMENTARIO INTEGER PRIMARY KEY AUTOINCREMENT,
      ID_POST INTEGER NOT NULL,
      ID_UTILIZADOR INTEGER NOT NULL,
      ID_AVALIACAO INTEGER NOT NULL,
      TEXTO_COMENTARIO TEXT NOT NULL,
      CONTADOR_LIKES_COM INTEGER NOT NULL,
      FOREIGN KEY (ID_POST) REFERENCES POST(ID_POST),
      FOREIGN KEY (ID_UTILIZADOR) REFERENCES UTILIZADOR(ID_UTILIZADOR),
      FOREIGN KEY (ID_AVALIACAO) REFERENCES AVALIACOES(ID_AVALIACAO)
    )
  ''');

  await db.execute('''
    CREATE TABLE TIPO_FORMATO (
      ID_FORMATO INTEGER PRIMARY KEY AUTOINCREMENT,
      FORMATO TEXT NOT NULL
    )
  ''');

  await db.execute('''
    CREATE TABLE CONTEUDOS (
      ID_CONTEUDO INTEGER PRIMARY KEY AUTOINCREMENT,
      ID_AULA INTEGER NOT NULL,
      ID_FORMATO INTEGER NOT NULL,
      CONTEUDO TEXT NOT NULL,
      FOREIGN KEY (ID_AULA) REFERENCES AULAS(ID_AULA),
      FOREIGN KEY (ID_FORMATO) REFERENCES TIPO_FORMATO(ID_FORMATO)
    )
  ''');

  await db.execute('''
    CREATE TABLE TIPO_DENUNCIA (
      ID_TIPO_DENUNCIA INTEGER PRIMARY KEY AUTOINCREMENT,
      TIPO_DENUNCIA TEXT NOT NULL
    )
  ''');

  await db.execute('''
    CREATE TABLE DENUNCIA (
      ID_DENUNCIA INTEGER PRIMARY KEY AUTOINCREMENT,
      ID_COMENTARIO INTEGER NOT NULL,
      ID_UTILIZADOR INTEGER NOT NULL,
      ID_POST INTEGER NOT NULL,
      ID_TIPO_DENUNCIA INTEGER NOT NULL,
      FOREIGN KEY (ID_UTILIZADOR) REFERENCES UTILIZADOR(ID_UTILIZADOR),
      FOREIGN KEY (ID_TIPO_DENUNCIA) REFERENCES TIPO_DENUNCIA(ID_TIPO_DENUNCIA),
      FOREIGN KEY (ID_POST) REFERENCES POST(ID_POST),
      FOREIGN KEY (ID_COMENTARIO) REFERENCES COMENTARIO(ID_COMENTARIO)
    )
  ''');

  await db.execute('''
    CREATE TABLE INSCRICOES (
      ID_INSCRICAO INTEGER PRIMARY KEY AUTOINCREMENT,
      ID_UTILIZADOR INTEGER NOT NULL,
      ID_FORMANDO INTEGER NOT NULL,
      ID_CURSO INTEGER NOT NULL,
      DATA_LIMITE TEXT NOT NULL,
      DATA_INICIO_INSC TEXT NOT NULL,
      STATUS_INSCRICAO INTEGER NOT NULL,
      FOREIGN KEY (ID_CURSO) REFERENCES CURSOS(ID_CURSO),
      FOREIGN KEY (ID_UTILIZADOR, ID_FORMANDO) REFERENCES FORMANDOS(ID_UTILIZADOR, ID_FORMANDO)
    )
  ''');

  await db.execute('''
    CREATE TABLE NOTIFICACOES_CURSO (
      ID_NOTIFICACAO_CURSOS INTEGER PRIMARY KEY AUTOINCREMENT,
      ID_UTILIZADOR INTEGER NOT NULL,
      ID_CURSO INTEGER NOT NULL,
      DATA_HORA_NOTIFICACAOCURSO TEXT NOT NULL,
      FOREIGN KEY (ID_UTILIZADOR) REFERENCES UTILIZADOR(ID_UTILIZADOR),
      FOREIGN KEY (ID_CURSO) REFERENCES CURSOS(ID_CURSO)
    )
  ''');

  await db.execute('''
    CREATE TABLE OCORRENCIAS_EDICOES (
      NR_OCORRENCIA INTEGER PRIMARY KEY,
      ID_CURSO INTEGER NOT NULL,
      FOREIGN KEY (ID_CURSO) REFERENCES CURSOS(ID_CURSO)
    )
  ''');

  await db.execute('''
    CREATE TABLE SINCRONO (
      ID_CURSO INTEGER NOT NULL,
      ID_CURSO_SINCRONO INTEGER PRIMARY KEY AUTOINCREMENT,
      ID_FORMADOR INTEGER NOT NULL,
      N_MAX_FORM INTEGER NOT NULL,
      FOREIGN KEY (ID_CURSO) REFERENCES CURSOS(ID_CURSO),
      FOREIGN KEY (ID_UTILIZADOR, ID_FORMADOR) REFERENCES FORMADORES(ID_UTILIZADOR, ID_FORMADOR)
    )
  ''');

  await db.execute('''
    CREATE TABLE RESULTADOS (
      ID_RESUL INTEGER PRIMARY KEY AUTOINCREMENT,
      ID_UTILIZADOR INTEGER NOT NULL,
      ID_FORMANDO INTEGER NOT NULL,
      ID_CURSO INTEGER NOT NULL,
      ID_CURSO_SINCRONO INTEGER NOT NULL,
      RESUL REAL NOT NULL,
      FOREIGN KEY (ID_CURSO, ID_CURSO_SINCRONO) REFERENCES SINCRONO(ID_CURSO, ID_CURSO_SINCRONO),
      FOREIGN KEY (ID_UTILIZADOR, ID_FORMANDO) REFERENCES FORMANDOS(ID_UTILIZADOR, ID_FORMANDO)
    )
  ''');
}

  }